Chat with Postgresql Database

https://n8nworkflows.xyz/workflows/chat-with-postgresql-database-2859


# Chat with Postgresql Database

### 1. Workflow Overview

This workflow enables natural language interaction with a PostgreSQL database via an AI-powered chat interface. It is designed for professionals who want to query their database using conversational language instead of writing SQL manually. The workflow listens for chat messages, processes them through an AI agent that dynamically generates and executes SQL queries, retrieves relevant data, and formulates responses back to the user.

The workflow is logically divided into the following blocks:

- **1.1 Input Reception:** Captures user chat messages from the n8n chat interface.
- **1.2 AI Processing and Memory:** Uses an AI agent to interpret user queries, maintain chat context, and generate SQL queries.
- **1.3 Database Interaction Tools:** Executes SQL queries and fetches database schema and table definitions to assist the AI agent.
- **1.4 Response Generation:** Uses an OpenAI chat model to generate natural language answers based on query results.
- **1.5 Setup and Documentation:** Provides setup instructions and tool descriptions as sticky notes for user guidance.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception

**Overview:**  
This block triggers the workflow when a user sends a chat message via the n8n chat interface.

**Nodes Involved:**  
- When chat message received

**Node Details:**  
- **When chat message received**  
  - Type: `@n8n/n8n-nodes-langchain.chatTrigger`  
  - Role: Entry point; listens for incoming chat messages.  
  - Configuration: Default options, webhook enabled with ID `cf1de04f-3e38-426c-89f0-3bdb110a5dcf`.  
  - Inputs: External chat interface webhook.  
  - Outputs: Passes message data to AI Agent node.  
  - Edge Cases: Webhook connectivity issues, malformed messages.  
  - Version: 1.1  

---

#### 2.2 AI Processing and Memory

**Overview:**  
This block interprets user input, maintains conversation context, and orchestrates AI-driven SQL query generation and execution.

**Nodes Involved:**  
- AI Agent  
- Chat History

**Node Details:**  
- **AI Agent**  
  - Type: `@n8n/n8n-nodes-langchain.agent`  
  - Role: Core AI logic; processes user input, decides which tools to invoke, and generates SQL queries and responses.  
  - Configuration: Uses the `openAiFunctionsAgent` with a system message instructing it to act as a DB assistant. It is aware of three tools: Execute SQL Query, Get DB Schema and Tables List, and Get Table Definition. The system message emphasizes schema-prefixed table names and fetching all data for analysis.  
  - Inputs: Receives chat messages from "When chat message received" node and chat history from "Chat History" node.  
  - Outputs: Sends SQL queries to database nodes and responses back to chat interface.  
  - Edge Cases: AI model misinterpretation, incomplete or ambiguous user queries, tool invocation failures, API rate limits.  
  - Version: 1.7  

- **Chat History**  
  - Type: `@n8n/n8n-nodes-langchain.memoryBufferWindow`  
  - Role: Maintains a sliding window of recent chat messages to provide context for the AI Agent.  
  - Configuration: Default context window length is 5 messages (modifiable).  
  - Inputs: Receives output from AI Agent to update memory.  
  - Outputs: Provides context back to AI Agent for each new message.  
  - Edge Cases: Memory overflow if window size is too large, loss of relevant context if window size is too small.  
  - Version: 1.3  

---

#### 2.3 Database Interaction Tools

**Overview:**  
This block contains nodes that interact directly with the PostgreSQL database to provide schema information and execute SQL queries generated by the AI agent.

**Nodes Involved:**  
- Execute SQL Query  
- Get DB Schema and Tables List  
- Get Table Definition

**Node Details:**  
- **Execute SQL Query**  
  - Type: `n8n-nodes-base.postgresTool`  
  - Role: Executes arbitrary SQL queries generated by the AI agent to fetch data.  
  - Configuration: Query is dynamically set from AI output variable `sql_query`. Uses PostgreSQL credentials.  
  - Inputs: Receives SQL query from AI Agent.  
  - Outputs: Returns query results to AI Agent for further processing.  
  - Edge Cases: SQL syntax errors, invalid queries, database connection failures, timeout errors.  
  - Version: 2.5  

- **Get DB Schema and Tables List**  
  - Type: `n8n-nodes-base.postgresTool`  
  - Role: Retrieves a list of all base tables and their schemas from the PostgreSQL database, excluding system schemas.  
  - Configuration: Executes a fixed SQL query on `information_schema.tables` filtering out `pg_catalog` and `information_schema` schemas. Uses PostgreSQL credentials.  
  - Inputs: Invoked by AI Agent as a tool.  
  - Outputs: Provides schema and table list to AI Agent.  
  - Edge Cases: Permission issues accessing `information_schema`, empty database.  
  - Version: 2.5  

- **Get Table Definition**  
  - Type: `n8n-nodes-base.postgresTool`  
  - Role: Retrieves detailed column and constraint information for a specified table and schema.  
  - Configuration: Executes a parameterized SQL query joining `information_schema.columns`, `key_column_usage`, `table_constraints`, and `constraint_column_usage` to get columns, data types, nullability, defaults, and foreign keys. Table and schema names are dynamically passed from AI Agent variables `table_name` and `schema_name`. Uses PostgreSQL credentials.  
  - Inputs: Invoked by AI Agent as a tool with parameters.  
  - Outputs: Returns table metadata to AI Agent.  
  - Edge Cases: Table or schema not found, permission denied, malformed parameters.  
  - Version: 2.5  

---

#### 2.4 Response Generation

**Overview:**  
This block uses an OpenAI chat model to generate natural language responses based on the AI agent’s analysis and retrieved data.

**Nodes Involved:**  
- OpenAI Chat Model

**Node Details:**  
- **OpenAI Chat Model**  
  - Type: `@n8n/n8n-nodes-langchain.lmChatOpenAi`  
  - Role: Language model that generates conversational responses.  
  - Configuration: Uses the `gpt-4o-mini` model by default. OpenAI API credentials are required.  
  - Inputs: Receives prompts and context from AI Agent.  
  - Outputs: Provides generated text back to AI Agent for final output.  
  - Edge Cases: API key invalid or expired, rate limits, model unavailability, network errors.  
  - Version: 1.2  

---

#### 2.5 Setup and Documentation

**Overview:**  
This block provides user guidance and tool descriptions via sticky notes embedded in the workflow canvas.

**Nodes Involved:**  
- Sticky Note  
- Sticky Note1  
- Sticky Note2  
- Sticky Note3

**Node Details:**  
- **Sticky Note**  
  - Type: `n8n-nodes-base.stickyNote`  
  - Role: Setup instructions for users to configure credentials and start chatting.  
  - Content Highlights: Add PostgreSQL and OpenAI credentials, activate workflow, make chat public.  
  - Position: Top-left corner for visibility.  

- **Sticky Note1**  
  - Type: `n8n-nodes-base.stickyNote`  
  - Role: Notes on chat model flexibility.  
  - Content: Indicates the chat model can be replaced with any other model.  

- **Sticky Note2**  
  - Type: `n8n-nodes-base.stickyNote`  
  - Role: Notes on context window length configuration.  
  - Content: Default context window length is 5 messages, adjustable via `Context Window Length` option.  

- **Sticky Note3**  
  - Type: `n8n-nodes-base.stickyNote`  
  - Role: Describes the tools used by the AI agent.  
  - Content: Lists Execute SQL Query, Get DB Schema and Tables List, and Get Table Definition with brief descriptions.  

---

### 3. Summary Table

| Node Name                 | Node Type                               | Functional Role                         | Input Node(s)             | Output Node(s)           | Sticky Note                                                                                          |
|---------------------------|---------------------------------------|---------------------------------------|---------------------------|--------------------------|----------------------------------------------------------------------------------------------------|
| When chat message received | @n8n/n8n-nodes-langchain.chatTrigger | Entry point; receives chat messages   | External webhook           | AI Agent                 | Setup instructions: Add PostgreSQL and OpenAI credentials, activate workflow, start chatting.      |
| AI Agent                  | @n8n/n8n-nodes-langchain.agent        | Core AI logic; generates SQL & answers| When chat message received, Chat History | Execute SQL Query, Get DB Schema and Tables List, Get Table Definition, Chat History | Describes AI agent role and tools used.                                                           |
| Chat History              | @n8n/n8n-nodes-langchain.memoryBufferWindow | Maintains chat context memory          | AI Agent                  | AI Agent                 | Context window length is 5 by default, configurable.                                               |
| Execute SQL Query         | n8n-nodes-base.postgresTool            | Executes AI-generated SQL queries     | AI Agent                  | AI Agent                 | Tool used by AI agent to execute SQL queries.                                                     |
| Get DB Schema and Tables List | n8n-nodes-base.postgresTool         | Retrieves list of tables and schemas  | AI Agent                  | AI Agent                 | Tool used by AI agent to get database schema and tables list.                                     |
| Get Table Definition      | n8n-nodes-base.postgresTool            | Retrieves detailed table metadata     | AI Agent                  | AI Agent                 | Tool used by AI agent to get table column and constraint info.                                   |
| OpenAI Chat Model         | @n8n/n8n-nodes-langchain.lmChatOpenAi | Generates natural language responses  | AI Agent                  | AI Agent                 | Chat model can be replaced with any other model.                                                  |
| Sticky Note               | n8n-nodes-base.stickyNote              | Setup instructions                    | None                      | None                     | Setup instructions for credentials and usage.                                                    |
| Sticky Note1              | n8n-nodes-base.stickyNote              | Chat model flexibility note           | None                      | None                     | Chat model can be exchanged with any other chat model.                                           |
| Sticky Note2              | n8n-nodes-base.stickyNote              | Context window length note             | None                      | None                     | Default context window length is 5 messages, adjustable.                                         |
| Sticky Note3              | n8n-nodes-base.stickyNote              | Tools description note                 | None                      | None                     | Describes tools used by AI agent: Execute SQL Query, Get DB Schema and Tables List, Get Table Definition. |

---

### 4. Reproducing the Workflow from Scratch

1. **Create "When chat message received" node**  
   - Type: `@n8n/n8n-nodes-langchain.chatTrigger`  
   - Configure webhook with default settings to receive chat messages.  

2. **Create "AI Agent" node**  
   - Type: `@n8n/n8n-nodes-langchain.agent`  
   - Set agent to `openAiFunctionsAgent`.  
   - Configure system message:  
     ```
     You are DB assistant. You need to run queries in DB aligned with user requests.

     Run custom SQL query to aggregate data and response to user. Make sure every table has schema prefix to it in sql query which you can get from `Get DB Schema and Tables List` tool.

     Fetch all data to analyse it for response if needed.

     ## Tools

     - Execute SQL query - Executes any sql query generated by AI
     - Get DB Schema and Tables List - Lists all the tables in database with its schema name
     - Get Table Definition - Gets the table definition from db using table name and schema name
     ```
   - Connect input from "When chat message received" node.  

3. **Create "Chat History" node**  
   - Type: `@n8n/n8n-nodes-langchain.memoryBufferWindow`  
   - Use default settings (context window length = 5).  
   - Connect output to AI Agent’s `ai_memory` input and AI Agent’s output to update memory.  

4. **Create "Execute SQL Query" node**  
   - Type: `n8n-nodes-base.postgresTool`  
   - Operation: `executeQuery`  
   - Query: `{{ $fromAI("sql_query", "SQL Query") }}` (dynamic from AI Agent)  
   - Set PostgreSQL credentials.  
   - Connect AI Agent’s `ai_tool` output to this node’s input.  

5. **Create "Get DB Schema and Tables List" node**  
   - Type: `n8n-nodes-base.postgresTool`  
   - Operation: `executeQuery`  
   - Query:  
     ```
     SELECT 
         table_schema,
         table_name
     FROM information_schema.tables
     WHERE table_type = 'BASE TABLE'
         AND table_schema NOT IN ('pg_catalog', 'information_schema')
     ORDER BY table_schema, table_name;
     ```  
   - Set PostgreSQL credentials.  
   - Connect AI Agent’s `ai_tool` output to this node’s input.  

6. **Create "Get Table Definition" node**  
   - Type: `n8n-nodes-base.postgresTool`  
   - Operation: `executeQuery`  
   - Query:  
     ```
     select
       c.column_name,
       c.data_type,
       c.is_nullable,
       c.column_default,
       tc.constraint_type,
       ccu.table_name AS referenced_table,
       ccu.column_name AS referenced_column
     from
       information_schema.columns c
     LEFT join
       information_schema.key_column_usage kcu
       ON c.table_name = kcu.table_name
       AND c.column_name = kcu.column_name
     LEFT join
       information_schema.table_constraints tc
       ON kcu.constraint_name = tc.constraint_name
       AND tc.constraint_type = 'FOREIGN KEY'
     LEFT join
       information_schema.constraint_column_usage ccu
       ON tc.constraint_name = ccu.constraint_name
     where
       c.table_name = '{{ $fromAI("table_name") }}'
       AND c.table_schema = '{{ $fromAI("schema_name") }}'
     order by
       c.ordinal_position
     ```  
   - Set PostgreSQL credentials.  
   - Connect AI Agent’s `ai_tool` output to this node’s input.  

7. **Create "OpenAI Chat Model" node**  
   - Type: `@n8n/n8n-nodes-langchain.lmChatOpenAi`  
   - Model: `gpt-4o-mini` (default)  
   - Set OpenAI API credentials.  
   - Connect AI Agent’s `ai_languageModel` input to this node.  

8. **Connect nodes as follows:**  
   - "When chat message received" → "AI Agent" (main)  
   - "Chat History" ↔ "AI Agent" (ai_memory) (bidirectional)  
   - "AI Agent" (ai_tool) → "Execute SQL Query"  
   - "AI Agent" (ai_tool) → "Get DB Schema and Tables List"  
   - "AI Agent" (ai_tool) → "Get Table Definition"  
   - "AI Agent" (ai_languageModel) → "OpenAI Chat Model"  

9. **Add Sticky Notes for user guidance:**  
   - Setup instructions: Add PostgreSQL and OpenAI credentials, activate workflow, start chatting.  
   - Chat model flexibility note.  
   - Context window length note.  
   - Tools description note.  

10. **Activate the workflow.**  
    - Ensure PostgreSQL and OpenAI credentials are configured and tested.  
    - Test chat interface by sending queries.  

---

### 5. General Notes & Resources

| Note Content                                                                                         | Context or Link                                                                                      |
|----------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| This workflow template is designed for professionals seeking relevant data from a PostgreSQL DB using natural language. | Workflow description and purpose.                                                                  |
| Template was created in n8n version `v1.77.0`.                                                     | Version compatibility note.                                                                         |
| Setup requires PostgreSQL credentials and OpenAI API key.                                         | Credential setup instructions.                                                                     |
| Tools used by AI Agent: Execute SQL Query, Get DB Schema and Tables List, Get Table Definition.    | See Sticky Note3 content for detailed tool descriptions.                                           |
| Chat model can be replaced with any other supported OpenAI or compatible chat model.               | See Sticky Note1 content.                                                                           |
| Default chat context window length is 5 messages, adjustable via `Context Window Length` option.  | See Sticky Note2 content.                                                                           |
| For more information on n8n chat nodes and LangChain integration, visit: https://docs.n8n.io/nodes/n8n-nodes-langchain/ | Official n8n documentation for LangChain nodes.                                                    |

---

This document provides a complete, structured reference to understand, reproduce, and modify the "Chat with Postgresql Database" workflow, including detailed node configurations, logical flow, and potential failure points.