Extract Invoice Data from PDFs to JSON with Gemini AI and XML Transformation

https://n8nworkflows.xyz/workflows/extract-invoice-data-from-pdfs-to-json-with-gemini-ai-and-xml-transformation-8460


# Extract Invoice Data from PDFs to JSON with Gemini AI and XML Transformation

### 1. Workflow Overview

This workflow automates the extraction and transformation of invoice data from PDF files submitted through a form. Its core purpose is to convert unstructured text extracted from PDFs into a structured JSON format via an intermediate XML representation generated by an AI model (Google Gemini). The workflow is designed for use cases such as automating invoice processing, data ingestion for accounting systems, or integration with ERP software.

The workflow is organized into four main logical blocks:

- **1.1 Input Reception and PDF Text Extraction:** Receives a PDF file via a form submission and extracts raw text content from it.
- **1.2 Data Cleaning and XML Schema Preparation:** Cleans the extracted text and prepares an XML schema template for AI-guided data transformation.
- **1.3 AI-Powered XML Generation:** Sends the cleaned text and XML schema to the Google Gemini AI model to generate an XML string representing the invoice data.
- **1.4 XML Parsing to JSON:** Cleans the AI-generated XML string and converts it into JSON format for downstream consumption.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception and PDF Text Extraction

- **Overview:**  
  This block handles the initial intake of invoice data by receiving a PDF file from a form submission and extracting its textual content for further processing.

- **Nodes Involved:**  
  - On form submission  
  - Extract from File  
  - Sticky Note (PDF to text)

- **Node Details:**

  - **On form submission**  
    - *Type:* Form Trigger  
    - *Role:* Entry point that triggers the workflow when a user submits a form containing a file upload field.  
    - *Configuration:* The form is titled "Test" and contains a single file field labeled "data".  
    - *Expressions:* None. The form data, including the uploaded file, is collected as workflow input.  
    - *Connections:* Outputs to "Extract from File".  
    - *Failure Modes:* Possible upload errors, missing file, or unsupported file type.  
    - *Version:* 2.3

  - **Extract from File**  
    - *Type:* Extract From File  
    - *Role:* Extracts text content from the uploaded PDF file.  
    - *Configuration:* Operation set to "pdf" extraction.  
    - *Expressions:* Operates on the file data received from the form submission node.  
    - *Connections:* Outputs extracted text to "Limpio data".  
    - *Failure Modes:* Unsupported or corrupt PDF files, extraction failures, timeout on large files.  
    - *Version:* 1

  - **Sticky Note (PDF to text)**  
    - *Type:* Sticky Note  
    - *Role:* Visual annotation for the block indicating the PDF to text extraction process.  
    - *Connections:* None

#### 2.2 Data Cleaning and XML Schema Preparation

- **Overview:**  
  This block cleans the raw extracted text by removing newline characters and defines the target XML structure as a template for AI processing.

- **Nodes Involved:**  
  - Limpio data  
  - Sticky Note1 (Clean data and XML structure definition)

- **Node Details:**

  - **Limpio data**  
    - *Type:* Set Node  
    - *Role:* Transforms raw text by removing newline characters and sets a multi-line XML schema template string as a variable.  
    - *Configuration:*  
      - `text_limpio`: Assigns the extracted text with all newline characters replaced by spaces for better AI input.  
      - `estructuraXML`: Defines the expected XML schema for invoices with placeholders for invoice fields (e.g., invoice_number, billed_to, items, financials). This schema guides the AI in constructing the XML output.  
    - *Expressions:*  
      - `text_limpio`: `{{$json.text.replace(/\n/g, ' ')}}`  
      - `estructuraXML`: Multi-line XML string with placeholder tags.  
    - *Connections:* Outputs to "Message a model".  
    - *Failure Modes:* Expression errors if input text is missing; invalid XML schema string formatting could cause AI confusion.  
    - *Version:* 3.4

  - **Sticky Note1 (Clean data and XML structure definition)**  
    - *Type:* Sticky Note  
    - *Role:* Visual annotation describing the purpose of this block as cleaning data and defining the XML structure.  
    - *Connections:* None

#### 2.3 AI-Powered XML Generation

- **Overview:**  
  This block sends the cleaned text and XML schema to the Google Gemini AI model, instructing it to rewrite the invoice transcription as an XML string following the given schema.

- **Nodes Involved:**  
  - Message a model  
  - Sticky Note2 (Generate XML string)

- **Node Details:**

  - **Message a model**  
    - *Type:* LangChain Google Gemini Node  
    - *Role:* Sends a prompt containing the invoice transcription and XML schema to the Gemini AI to generate a structured XML string.  
    - *Configuration:*  
      - Model ID: `models/gemma-3n-e4b-it` (presumably a Gemini model specialized for text generation).  
      - Prompt message uses templated expressions to insert the XML schema (`$json.estructuraXML`) and cleaned invoice text (`$json.text_limpio`).  
      - Message content instructs the AI to rewrite the invoice transcription into XML format complying with the provided schema.  
      - Credentials: Uses a Google Palm API credential named "Google Gemini(PaLM) Api account 2".  
    - *Expressions:*  
      - Message content:  
        ```
        Considera la transcripcion del invoice adjunta, reescribela como un XML siguiendo este esquema:

        {{ $json.estructuraXML }}

        Invoice:

        {{ $json.text_limpio }}
        ```  
    - *Connections:* Outputs AI response to "Limpio XML".  
    - *Failure Modes:* API auth errors, rate limits, malformed prompt inputs, timeout, unexpected AI output format.  
    - *Version:* 1

  - **Sticky Note2 (Generate XML string)**  
    - *Type:* Sticky Note  
    - *Role:* Visual annotation indicating this block generates the XML string from AI.  
    - *Connections:* None

#### 2.4 XML Parsing to JSON

- **Overview:**  
  Cleans the AI-generated XML string to remove markdown artifacts and whitespace, then parses it into JSON format for programmatic use.

- **Nodes Involved:**  
  - Limpio XML  
  - XML to JSON  
  - Sticky Note3 (String to XML to JSON)

- **Node Details:**

  - **Limpio XML**  
    - *Type:* Set Node  
    - *Role:* Cleans the raw AI-generated XML string by removing markdown code block syntax (```xml and ```) and excess whitespace to produce a well-formed XML string.  
    - *Configuration:*  
      - Assigns `factura_limpia` by replacing/removing markdown tags and extra spaces in `$json.content.parts[0].text`.  
      - Uses chained `.replace()` calls and regex to remove unwanted characters and spacing.  
    - *Expressions:*  
      ```
      $json.content.parts[0].text
        .replace('```xml', '')
        .replace('```', '')
        .replace(/(\n|\s{2,})/g, '')
        .replace(/(\s<)/g, '<')
        .replace(/(>\s)/g, '>')
      ```  
    - *Connections:* Outputs cleaned XML string to "XML to JSON".  
    - *Failure Modes:* If AI output format changes, expression could fail; missing or malformed `content.parts[0].text` field; incomplete cleanup causing XML parse errors.  
    - *Version:* 3.4

  - **XML to JSON**  
    - *Type:* XML Node  
    - *Role:* Converts the cleaned XML string into JSON format.  
    - *Configuration:*  
      - Options: No trimming, normalization, or tag normalization applied to preserve XML fidelity as much as possible.  
      - Data property to parse: `factura_limpia`.  
    - *Expressions:* None.  
    - *Connections:* Terminal node (no outputs).  
    - *Failure Modes:* XML parsing errors if input XML malformed, empty, or invalid structure.  
    - *Version:* 1

  - **Sticky Note3 (String to XML to JSON)**  
    - *Type:* Sticky Note  
    - *Role:* Visual annotation describing this block’s function of converting AI-generated string output into usable JSON.  
    - *Connections:* None

---

### 3. Summary Table

| Node Name           | Node Type                      | Functional Role                          | Input Node(s)          | Output Node(s)           | Sticky Note                       |
|---------------------|--------------------------------|----------------------------------------|-----------------------|--------------------------|----------------------------------|
| On form submission  | Form Trigger                   | Receives PDF upload via form            | —                     | Extract from File        | PDF to text                      |
| Extract from File   | Extract From File              | Extracts text content from PDF          | On form submission    | Limpio data              | PDF to text                      |
| Limpio data         | Set Node                      | Cleans text, sets XML schema template   | Extract from File     | Message a model          | Clean data and XML structure definition |
| Message a model     | LangChain Google Gemini Node  | Sends prompt to AI to generate XML      | Limpio data           | Limpio XML               | Generate XML string              |
| Limpio XML          | Set Node                      | Cleans AI XML string output              | Message a model       | XML to JSON              | String to XML to Json            |
| XML to JSON         | XML Node                      | Parses cleaned XML to JSON                | Limpio XML            | —                        | String to XML to Json            |
| Sticky Note         | Sticky Note                   | Visual annotation                        | —                     | —                        | PDF to text                      |
| Sticky Note1        | Sticky Note                   | Visual annotation                        | —                     | —                        | Clean data and XML structure definition |
| Sticky Note2        | Sticky Note                   | Visual annotation                        | —                     | —                        | Generate XML string              |
| Sticky Note3        | Sticky Note                   | Visual annotation                        | —                     | —                        | String to XML to Json            |

---

### 4. Reproducing the Workflow from Scratch

1. **Create a Form Trigger Node**  
   - Type: `Form Trigger`  
   - Name: `On form submission`  
   - Configure form title as "Test".  
   - Add a form field: Type `file`, Label `data`.  
   - This node waits for user input with a PDF file upload.  

2. **Add Extract From File Node**  
   - Type: `Extract From File`  
   - Name: `Extract from File`  
   - Set operation to `pdf`.  
   - Connect `On form submission` output to this node input.  
   - This node extracts text from the uploaded PDF.  

3. **Add Set Node to Clean Text and Define XML Schema**  
   - Type: `Set`  
   - Name: `Limpio data`  
   - Connect output of `Extract from File` here.  
   - Add two fields:  
     - `text_limpio` (string): Set value to `{{$json.text.replace(/\n/g, ' ')}}` to remove newlines.  
     - `estructuraXML` (string): Paste the full multi-line XML template representing the desired invoice XML structure with placeholders for invoice fields.  
   - This prepares cleaned text and XML schema for AI.  

4. **Add LangChain Google Gemini Node**  
   - Type: `@n8n/n8n-nodes-langchain.googleGemini`  
   - Name: `Message a model`  
   - Connect output of `Limpio data` here.  
   - Set `modelId` to `models/gemma-3n-e4b-it`.  
   - Message content:  
     ```
     Considera la transcripcion del invoice adjunta, reescribela como un XML siguiendo este esquema:

     {{ $json.estructuraXML }}

     Invoice:

     {{ $json.text_limpio }}
     ```  
   - Select Google Palm API credentials configured with the ID `d4exk6UjdeHXH93h` or your own valid credential.  
   - This sends the cleaned invoice text and XML schema to Gemini AI for XML generation.  

5. **Add a Set Node to Clean AI XML Output**  
   - Type: `Set`  
   - Name: `Limpio XML`  
   - Connect output of `Message a model` here.  
   - Add a field `factura_limpia` (string) with value set by the expression:  
     ```
     {{$json.content.parts[0].text.replace('```xml', '').replace('```', '').replace(/(\n|\s{2,})/g, '').replace(/(\s<)/g, '<').replace(/(>\s)/g, '>')}}
     ```  
   - This removes markdown code block indicators and excess whitespace from AI output.  

6. **Add XML Node to Convert XML to JSON**  
   - Type: `XML`  
   - Name: `XML to JSON`  
   - Connect output of `Limpio XML` here.  
   - Set options:  
     - Trim: false  
     - Normalize: false  
     - Normalize Tags: false  
   - Set `Data Property Name` to `factura_limpia`.  
   - This converts the cleaned XML string into structured JSON.  

7. **Optional: Add Sticky Notes**  
   - Add sticky notes to annotate each block visually for clarity:  
     - PDF to text (covering "On form submission" and "Extract from File")  
     - Clean data and XML structure definition (on "Limpio data")  
     - Generate XML string (on "Message a model")  
     - String to XML to JSON (covering "Limpio XML" and "XML to JSON")

---

### 5. General Notes & Resources

| Note Content                                                                                                   | Context or Link                                  |
|---------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
| The XML schema template used in the workflow must be adapted if invoice structures differ significantly.       | Within `Limpio data` node’s `estructuraXML` field |
| Google Gemini API requires valid API credentials and may have usage limits; ensure API key management is secure.| Google Palm API credential setup in n8n          |
| The workflow assumes the AI model reliably outputs XML within markdown code blocks; changes in AI output format require adjustments to cleaning expressions.| Relevant for `Limpio XML` node cleaning logic    |
| XML parsing node options are set to preserve original tag formatting; if XML normalization is needed, adjust accordingly.| `XML to JSON` node configuration                  |

---

**Disclaimer:** The text provided comes exclusively from an automated workflow created with n8n, a tool for integration and automation. This processing strictly complies with current content policies and contains no illegal, offensive, or protected elements. All data handled is legal and public.