ðŸ—¼ AI Powered Supply Chain Control Tower with BigQuery and GPT-4o

https://n8nworkflows.xyz/workflows/---ai-powered-supply-chain-control-tower-with-bigquery-and-gpt-4o-3305


# ðŸ—¼ AI Powered Supply Chain Control Tower with BigQuery and GPT-4o

### 1. Workflow Overview

This workflow implements an **AI-powered Supply Chain Control Tower** designed to provide logistics operations teams with an interactive chat interface to query and analyze outbound shipment data stored in Google BigQuery. It leverages GPT-4o (OpenAI) to interpret user questions, generate SQL queries dynamically, execute those queries on BigQuery, and return concise, structured answers in natural language or tabular form.

The workflow is logically divided into four main blocks:

- **1.1 Input Reception:** Captures user questions via a chat interface (chat trigger node).
- **1.2 AI Processing:** Uses an AI agent powered by GPT-4o to understand the user query, generate SQL, and manage conversation memory.
- **1.3 Query Execution:** Sanitizes and executes the generated SQL query on Google BigQuery, retrieving shipment data.
- **1.4 Response Delivery:** Returns the query results back to the AI agent, which formats and sends the response to the user.

This modular design allows easy replacement of the chat input method (e.g., Teams, Slack) and reuse of the BigQuery execution sub-workflow for other AI agents.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception

**Overview:**  
This block triggers the workflow upon receiving a user message via a chat interface. It initiates the AI processing chain.

**Nodes Involved:**  
- Chat with the User

**Node Details:**

- **Chat with the User**  
  - Type: `@n8n/n8n-nodes-langchain.chatTrigger`  
  - Role: Entry point for user input via chat; listens for incoming messages.  
  - Configuration: Uses a webhook ID to receive chat messages; no additional parameters configured.  
  - Inputs: External chat messages (via webhook).  
  - Outputs: Sends user message to the AI Control Tower Agent node.  
  - Edge Cases: Webhook connectivity issues, malformed input messages.  
  - Notes: Can be replaced by other chat triggers (Telegram, Slack, Teams) or a webhook for integration with customer chat windows.

---

#### 2.2 AI Processing

**Overview:**  
This block interprets the userâ€™s natural language question, generates an appropriate SQL query to retrieve data from BigQuery, and maintains chat memory for context-aware conversations.

**Nodes Involved:**  
- AI Control Tower Agent  
- OpenAI Chat Model  
- Chat Memory

**Node Details:**

- **AI Control Tower Agent**  
  - Type: `@n8n/n8n-nodes-langchain.agent`  
  - Role: Core AI logic node that processes user input, generates SQL queries, and manages interaction with the query execution tool.  
  - Configuration:  
    - System prompt defines the AI as a SQL assistant specialized in supply chain analytics.  
    - Specifies behavior rules: no SQL query display, structured data output, result formatting, row limits, and clarifications for broad queries.  
    - Schema awareness: references the BigQuery table `transport.shipments` and its fields.  
    - Tool usage: expects to call a tool named `bigquery_tool` with JSON input containing the SQL query string.  
  - Inputs: User message from chat trigger, chat memory, OpenAI chat model, and query tool outputs.  
  - Outputs: Sends SQL query to the query tool and final response back to the chat.  
  - Edge Cases: Incorrect or ambiguous user queries, AI model timeouts, API quota limits, malformed SQL generation.  
  - Version: Uses LangChain agent node version 1.8.

- **OpenAI Chat Model**  
  - Type: `@n8n/n8n-nodes-langchain.lmChatOpenAi`  
  - Role: Provides GPT-4o language model capabilities for the AI Control Tower Agent.  
  - Configuration: Model set to `gpt-4o-mini`.  
  - Inputs: Receives prompts from the AI Control Tower Agent.  
  - Outputs: Returns generated text or SQL queries to the AI Control Tower Agent.  
  - Edge Cases: API key authentication errors, rate limits, model unavailability.

- **Chat Memory**  
  - Type: `@n8n/n8n-nodes-langchain.memoryBufferWindow`  
  - Role: Maintains conversational context to allow follow-up questions and coherent multi-turn dialogue.  
  - Configuration: Default buffer window memory; no custom parameters.  
  - Inputs: Conversation data from the AI Control Tower Agent.  
  - Outputs: Provides context to the AI Control Tower Agent for subsequent queries.  
  - Edge Cases: Memory overflow or loss, context misinterpretation.

---

#### 2.3 Query Execution

**Overview:**  
This block receives the SQL query generated by the AI agent, sanitizes it to remove formatting artifacts, executes it on Google BigQuery, and returns the raw results.

**Nodes Involved:**  
- Call Query Tool (Tool Workflow node)  
- Trigger Executed by the AI Tool  
- Sanitising the Query  
- Query Database

**Node Details:**

- **Call Query Tool**  
  - Type: `@n8n/n8n-nodes-langchain.toolWorkflow`  
  - Role: Invokes a separate sub-workflow named `bigquery_tool` to execute SQL queries on BigQuery.  
  - Configuration:  
    - Points to workflow ID `4Os7DoxHjFuTwWio` (BigQuery execution workflow).  
    - Passes the SQL query string extracted from AI agent output as input parameter `query`.  
    - Description instructs to provide only the raw SQL query string without formatting or comments.  
  - Inputs: SQL query JSON from AI Control Tower Agent.  
  - Outputs: Query results from BigQuery sub-workflow.  
  - Edge Cases: Workflow ID mismatch, sub-workflow errors, input mapping failures.

- **Trigger Executed by the AI Tool**  
  - Type: `n8n-nodes-base.executeWorkflowTrigger`  
  - Role: Entry trigger node inside the BigQuery sub-workflow that receives the SQL query parameter.  
  - Configuration: Accepts `query` as workflow input parameter.  
  - Inputs: Called by the `Call Query Tool` node.  
  - Outputs: Passes query to the sanitizing node.  
  - Edge Cases: Missing or malformed query input.

- **Sanitising the Query**  
  - Type: `n8n-nodes-base.code` (JavaScript)  
  - Role: Cleans the SQL query string by removing markdown code block delimiters (```sql and ```) and trimming whitespace.  
  - Configuration: Custom JS code:  
    ```js
    return [
      {
        json: {
          query: $input.first().json.query.replace(/```sql|```/g, "").trim()
        }
      }
    ];
    ```  
  - Inputs: Raw query string from trigger node.  
  - Outputs: Cleaned SQL query string to the BigQuery node.  
  - Edge Cases: Queries without code block formatting, unexpected input structure.

- **Query Database**  
  - Type: `n8n-nodes-base.googleBigQuery`  
  - Role: Executes the sanitized SQL query on Google BigQuery and fetches results.  
  - Configuration:  
    - SQL query set dynamically from input JSON `query` field.  
    - Project ID configured via credentials (must be set by user).  
  - Inputs: Cleaned SQL query from sanitizing node.  
  - Outputs: Query results returned to the AI Control Tower Agent via the tool workflow.  
  - Edge Cases: Authentication errors, SQL syntax errors, query timeouts, BigQuery API limits.

---

#### 2.4 Response Delivery

**Overview:**  
This block sends the AI-generated, formatted response back to the user chat interface.

**Nodes Involved:**  
- AI Control Tower Agent (output connection)  
- Chat with the User (input connection)

**Node Details:**

- The AI Control Tower Agent node outputs the final answer after receiving query results from BigQuery.  
- The response is sent back through the chat trigger nodeâ€™s webhook to the user interface.  
- Edge Cases: Network failures delivering the message, malformed response formatting.

---

### 3. Summary Table

| Node Name                  | Node Type                                  | Functional Role                          | Input Node(s)               | Output Node(s)              | Sticky Note                                                                                                                                            |
|----------------------------|--------------------------------------------|----------------------------------------|-----------------------------|-----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| Chat with the User          | @n8n/n8n-nodes-langchain.chatTrigger       | Workflow trigger, receives user input  | External webhook             | AI Control Tower Agent       | ### 1. Workflow Trigger with Chat<br>This workflow uses a simple chat window as a trigger. You can replace it with Telegram, Slack, Teams or webhook.  |
| AI Control Tower Agent      | @n8n/n8n-nodes-langchain.agent              | AI processing, SQL generation, response| Chat with the User, Chat Memory, OpenAI Chat Model, Call Query Tool | Chat with the User           | ### 2. AI Agent equipped with the query tool<br>Use AI Agent with Chat Model and BigQuery tool workflow for SQL generation and execution.             |
| OpenAI Chat Model           | @n8n/n8n-nodes-langchain.lmChatOpenAi       | Provides GPT-4o language model         | AI Control Tower Agent       | AI Control Tower Agent       | ### 2. AI Agent equipped with the query tool<br>Use OpenAI 4o-mini model with proper credentials.                                                     |
| Chat Memory                | @n8n/n8n-nodes-langchain.memoryBufferWindow | Maintains conversation context         | AI Control Tower Agent       | AI Control Tower Agent       |                                                                                                                                                        |
| Call Query Tool             | @n8n/n8n-nodes-langchain.toolWorkflow       | Invokes BigQuery sub-workflow           | AI Control Tower Agent       | AI Control Tower Agent       | ### 2. AI Agent equipped with the query tool<br>Calls the BigQuery execution workflow to run SQL queries.                                             |
| Trigger Executed by the AI Tool | n8n-nodes-base.executeWorkflowTrigger   | Entry trigger for BigQuery sub-workflow| Call Query Tool              | Sanitising the Query         | ### 3. Big Query Workflow<br>Sub-workflow entry point for executing SQL queries on BigQuery.                                                          |
| Sanitising the Query        | n8n-nodes-base.code                         | Cleans SQL query string                 | Trigger Executed by the AI Tool | Query Database             | ### 3. Big Query Workflow<br>Removes markdown formatting from SQL query before execution.                                                             |
| Query Database              | n8n-nodes-base.googleBigQuery               | Executes SQL query on BigQuery          | Sanitising the Query         | Trigger Executed by the AI Tool (return path) | ### 3. Big Query Workflow<br>Executes query and returns results to AI agent.                                                                          |
| Sticky Note1                | n8n-nodes-base.stickyNote                    | Documentation note                      |                             |                             | ### 1. Workflow Trigger with Chat<br>This workflow uses a simple chat window as a trigger. You can replace it with Telegram, Slack, Teams or webhook.  |
| Sticky Note2                | n8n-nodes-base.stickyNote                    | Documentation note                      |                             |                             | ### 2. AI Agent equipped with the query tool<br>Instructions on setting up AI Agent and BigQuery tool workflow.                                        |
| Sticky Note                 | n8n-nodes-base.stickyNote                    | Documentation note                      |                             |                             | ### 3. Big Query Workflow<br>Instructions on setting up Google BigQuery API credentials and project configuration.                                     |
| Sticky Note3                | n8n-nodes-base.stickyNote                    | Documentation note                      |                             |                             | ### 4. Do you need more details?<br>Step-by-step guide and video tutorial link.<br>![Guide](https://www.samirsaci.com/content/images/2025/04/image.png)<br>[ðŸŽ¥ Watch My Tutorial](https://www.loom.com/share/50271f9d50214d7184830985497a75ec?sid=d0c410dc-29f1-488f-b89a-4011de0ded07) |

---

### 4. Reproducing the Workflow from Scratch

1. **Create Chat Trigger Node**  
   - Add node: `@n8n/n8n-nodes-langchain.chatTrigger`  
   - Configure webhook ID (auto-generated or custom) to receive user chat messages.  
   - No additional parameters needed.

2. **Add AI Control Tower Agent Node**  
   - Add node: `@n8n/n8n-nodes-langchain.agent`  
   - Set system message prompt describing AI as SQL assistant specialized in supply chain analytics.  
   - Define behavior rules for query execution, data presentation, response formatting, and clarifications.  
   - Specify schema awareness for BigQuery table `transport.shipments`.  
   - Configure tool usage to call a tool named `bigquery_tool` with input JSON containing the SQL query string.  
   - Connect input from Chat Trigger node.  
   - Connect outputs to Chat Trigger (for response), OpenAI Chat Model, Chat Memory, and Call Query Tool nodes.

3. **Add OpenAI Chat Model Node**  
   - Add node: `@n8n/n8n-nodes-langchain.lmChatOpenAi`  
   - Select model `gpt-4o-mini`.  
   - Configure OpenAI API credentials.  
   - Connect input from AI Control Tower Agent node.  
   - Connect output back to AI Control Tower Agent node.

4. **Add Chat Memory Node**  
   - Add node: `@n8n/n8n-nodes-langchain.memoryBufferWindow`  
   - Use default settings.  
   - Connect input and output to AI Control Tower Agent node to maintain conversation context.

5. **Add Tool Workflow Node (Call Query Tool)**  
   - Add node: `@n8n/n8n-nodes-langchain.toolWorkflow`  
   - Set workflow name to your BigQuery execution sub-workflow (create next).  
   - Map input parameter `query` to the AI Control Tower Agentâ€™s output field containing the SQL query string.  
   - Connect input from AI Control Tower Agent node.  
   - Connect output back to AI Control Tower Agent node.

6. **Create BigQuery Execution Sub-Workflow**  
   - Add node: `n8n-nodes-base.executeWorkflowTrigger`  
     - Configure input parameter `query` (string).  
   - Add node: `n8n-nodes-base.code` (Sanitising the Query)  
     - Paste JS code to remove markdown formatting from SQL query:  
       ```js
       return [
         {
           json: {
             query: $input.first().json.query.replace(/```sql|```/g, "").trim()
           }
         }
       ];
       ```  
     - Connect input from executeWorkflowTrigger node.  
   - Add node: `n8n-nodes-base.googleBigQuery`  
     - Set SQL query to `={{ $json.query }}` (dynamic).  
     - Configure Google BigQuery credentials with appropriate project ID and permissions.  
     - Connect input from Sanitising the Query node.  
   - Connect output of Google BigQuery node back to the executeWorkflowTrigger nodeâ€™s return path to send results back to the calling workflow.

7. **Connect Nodes in Main Workflow**  
   - Connect Chat Trigger â†’ AI Control Tower Agent â†’ OpenAI Chat Model, Chat Memory, Call Query Tool â†’ AI Control Tower Agent â†’ Chat Trigger (response).  
   - Ensure Call Query Tool node points to the BigQuery execution sub-workflow.

8. **Credential Setup**  
   - Configure OpenAI API credentials for GPT-4o model access.  
   - Configure Google BigQuery credentials with access to the project and dataset containing the `transport.shipments` table.

9. **Testing and Validation**  
   - Test chat input with sample questions about shipments.  
   - Verify AI generates correct SQL queries, queries run successfully on BigQuery, and responses are returned in clear English or tables.  
   - Handle errors such as invalid SQL, API timeouts, or missing credentials.

---

### 5. General Notes & Resources

| Note Content                                                                                                   | Context or Link                                                                                             |
|---------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------|
| This workflow uses a simple chat window as a trigger but can be replaced with Teams, Telegram, Slack, or webhook. | Sticky Note1 in workflow                                                                                     |
| AI Agent node uses a system prompt tailored for supply chain analytics and calls a BigQuery tool workflow.     | Sticky Note2 in workflow                                                                                     |
| BigQuery sub-workflow requires Google BigQuery API credentials and project configuration.                      | Sticky Note (near BigQuery nodes)                                                                            |
| Step-by-step guide and video tutorial available for detailed setup and usage.                                  | [ðŸŽ¥ Watch My Tutorial](https://www.loom.com/share/50271f9d50214d7184830985497a75ec?sid=946c1a96-2274-463f-b4bd-4ef295e2b949) |
| Founder and author: Samir, Supply Chain Engineer and Data Scientist, founder of LogiGreen Consulting.          | [LogiGreen Consulting](https://logi-green.com), [LinkedIn](https://www.linkedin.com/in/samir-saci)           |
| Workflow built with n8n version 1.82.1, submitted March 24, 2025.                                              | Metadata                                                                                                    |

---

This documentation provides a complete, structured understanding of the AI Powered Supply Chain Control Tower workflow, enabling reproduction, modification, and troubleshooting by advanced users and automation agents alike.