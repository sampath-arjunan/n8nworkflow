Monitor TP-Link Omada Network Disconnections with Gmail & Pushover

https://n8nworkflows.xyz/workflows/monitor-tp-link-omada-network-disconnections-with-gmail---pushover-7886


# Monitor TP-Link Omada Network Disconnections with Gmail & Pushover

### 1. Workflow Overview

This workflow monitors disconnections of devices managed by the TP-Link Omada Controller by processing alert emails and logging device statuses into Google Sheets. It periodically checks for devices that have been disconnected or isolated for over 30 minutes and notifies the user via Pushover. Additionally, the workflow cleans up old data entries every two days to maintain the Google Sheets log.

Logical blocks included:

- **1.1 Input Reception:** Receives alert emails from the Omada Controller through Gmail.
- **1.2 Email Processing and Logging:** Parses incoming emails, extracts critical device information, and logs these into a Google Sheets document.
- **1.3 Periodic Status Check:** Every 5 minutes, retrieves logged data from Google Sheets and filters devices that have been disconnected or isolated for over 30 minutes without prior alert.
- **1.4 Alerting and Status Update:** Sends push notifications for overdue disconnections and updates the Google Sheets to mark those alerts as sent.
- **1.5 Data Maintenance:** Clears old rows from Google Sheets every two days to keep the dataset manageable.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception

- **Overview:** Monitors incoming emails in Gmail for alerts generated by the Omada Controller.
- **Nodes Involved:**  
  - Receives Alert
- **Node Details:**

  - **Receives Alert**  
    - Type: Gmail Trigger  
    - Role: Listens to Gmail inbox for new emails, triggering workflow when an email is received.  
    - Configuration: Polls every minute without specific filters (`q` is empty).  
    - Inputs: None (trigger node)  
    - Outputs: Email data passed downstream to process.  
    - Edge Cases: Potential Gmail API rate limits, authentication expiry, or missing emails if polling interval is too long.  
    - Notes: Requires Gmail OAuth2 credentials.

#### 2.2 Email Processing and Logging

- **Overview:** Parses the raw email content to extract device details such as MAC address, status, timestamps, and other metadata, then appends this structured data to a Google Sheet for record-keeping.
- **Nodes Involved:**  
  - Process Email and Extract  
  - Append Row in Sheet
- **Node Details:**

  - **Process Email and Extract**  
    - Type: Code  
    - Role: Processes all input items (rows) to filter and return only devices that are disconnected or isolated and have passed a 30-minute threshold without alerts sent.  
    - Configuration: JavaScript code groups rows by MAC address to find the latest entry per device, checks timestamps, statuses, and alert flags.  
    - Key expressions: Uses Date parsing, grouping by MAC, filtering by status and timestamps, and alertSent flags.  
    - Inputs: Email data (but actually expects rows from Google Sheets, see connections).  
    - Outputs: Filtered list of overdue devices.  
    - Edge Cases: Invalid timestamps, missing MAC addresses, malformed data.  
    - Note: The provided code snippet is a refined version of the logic used in "Check Device and Notify" node.
  
  - **Append Row in Sheet**  
    - Type: Google Sheets  
    - Role: Logs structured device data into Google Sheets by appending new rows.  
    - Configuration: Maps extracted fields (mac, name, type, status, severity, timestamps, alert flags) to defined columns in a specific sheet and document.  
    - Inputs: Structured JSON from code node.  
    - Outputs: Confirmation of row append operation.  
    - Credentials: Uses Google Sheets OAuth2 credentials.  
    - Edge Cases: Google Sheets API errors, schema mismatches, permission errors.

#### 2.3 Periodic Status Check

- **Overview:** Every 5 minutes, retrieves all logged device statuses from Google Sheets and identifies devices disconnected or isolated for more than 30 minutes without alert notification sent.
- **Nodes Involved:**  
  - Check Every 5 minutes  
  - Get Row(s) in Sheet  
  - Check Device and Notify
- **Node Details:**

  - **Check Every 5 minutes**  
    - Type: Schedule Trigger  
    - Role: Initiates workflow every 5 minutes to perform status checks.  
    - Configuration: Interval set on minutes (every 5 minutes).  
    - Inputs: None (trigger node)  
    - Outputs: Triggers downstream nodes.  
    - Edge Cases: Workflow delays or scheduling conflicts.
  
  - **Get Row(s) in Sheet**  
    - Type: Google Sheets  
    - Role: Reads all rows from a specified Google Sheets document and sheet where device statuses are logged.  
    - Configuration: Uses specified document ID and sheet ID.  
    - Credentials: Google Sheets OAuth2.  
    - Inputs: Trigger input from schedule.  
    - Outputs: Rows data for analysis.  
    - Edge Cases: Large datasets causing timeouts, API limits, or permission errors.
  
  - **Check Device and Notify**  
    - Type: Code  
    - Role: Filters devices to find those disconnected or isolated for more than 30 minutes and not yet alerted, adjusting timestamps to Philippine time (UTC+8).  
    - Configuration: JavaScript code grouping by MAC, comparing timestamps, checking alert flags, and filtering overdue devices.  
    - Key expressions: Date comparisons with local time offset, string normalization for status and alertSent flags.  
    - Inputs: Rows from Google Sheets node.  
    - Outputs: List of devices requiring alert or a debug message if none found.  
    - Edge Cases: Timezone errors, invalid or missing dates, incorrect flags.

#### 2.4 Alerting and Status Update

- **Overview:** For each overdue disconnected device, sends a push notification via Pushover and updates the Google Sheet row to mark the alert as sent.
- **Nodes Involved:**  
  - Update Alert  
  - Alert User
- **Node Details:**

  - **Update Alert**  
    - Type: Google Sheets  
    - Role: Updates specific rows in Google Sheets to set `alertSent` column to `true` for devices that have been alerted.  
    - Configuration: Matches rows by `rowId` and updates the alertSent flag.  
    - Credentials: Google Sheets OAuth2.  
    - Inputs: Filtered device list from code node.  
    - Outputs: Confirmation of update.  
    - Edge Cases: Row not found, concurrency issues, API errors.
  
  - **Alert User**  
    - Type: Pushover  
    - Role: Sends a push notification with device name, status, and timestamp formatted message to user.  
    - Configuration: Uses user-specific Pushover user key and default priority 0.  
    - Credentials: Pushover API credentials.  
    - Inputs: Device data from code node.  
    - Outputs: Notification success/failure.  
    - Edge Cases: Network errors, invalid API credentials, rate limits.

#### 2.5 Data Maintenance

- **Overview:** Every two days at 2 AM, clears old rows from the Google Sheets document to keep the data fresh and manageable.
- **Nodes Involved:**  
  - Clear Rows Every 2 days  
  - Clear sheet
- **Node Details:**

  - **Clear Rows Every 2 days**  
    - Type: Schedule Trigger  
    - Role: Triggers the cleanup operation every two days at 2:00 AM.  
    - Configuration: Interval set to 2 days with trigger hour 2.  
    - Inputs: None (trigger node)  
    - Outputs: Triggers Clear sheet node.  
    - Edge Cases: Scheduler downtime or misfire.
  
  - **Clear sheet**  
    - Type: Google Sheets  
    - Role: Clears 500 rows starting from row 2 (to avoid headers) in the specified sheet, effectively deleting old data.  
    - Configuration: Operation set to clear specific rows, starting index 2, rows to delete 500.  
    - Credentials: Google Sheets OAuth2.  
    - Inputs: Trigger from the schedule node.  
    - Outputs: Confirmation of clearing.  
    - Edge Cases: Permissions errors, partial clear failures.

---

### 3. Summary Table

| Node Name               | Node Type             | Functional Role                               | Input Node(s)          | Output Node(s)            | Sticky Note                                                                                         |
|-------------------------|-----------------------|-----------------------------------------------|-----------------------|---------------------------|---------------------------------------------------------------------------------------------------|
| Receives Alert          | Gmail Trigger          | Receives Omada alert emails                    | —                     | Process Email and Extract  | **Receives Alert**: Gmail trigger for Omada Controller emails                                    |
| Process Email and Extract | Code                  | Parses alerts and extracts structured fields  | Receives Alert         | Append Row in Sheet         | **Process Email and Extract**: Extracts timestamp, device name, MAC, severity, status            |
| Append Row in Sheet      | Google Sheets          | Logs extracted data into Google Sheets         | Process Email and Extract | —                         | **Append Row in Sheet**: Logs data to Google Sheets                                              |
| Check Every 5 minutes    | Schedule Trigger       | Triggers periodic status checks every 5 minutes | —                     | Get Row(s) in Sheet        | **Check Every 5 minutes**: Scheduled polling to detect overdue disconnections                     |
| Get Row(s) in Sheet      | Google Sheets          | Retrieves logged device status rows             | Check Every 5 minutes  | Check Device and Notify    |                                                                                                   |
| Check Device and Notify  | Code                   | Filters devices disconnected >30 minutes       | Get Row(s) in Sheet    | Update Alert, Alert User    | **Check Device and Notify**: Filters devices disconnected >30 minutes                            |
| Update Alert             | Google Sheets          | Marks device rows as alerted                     | Check Device and Notify | —                         | **Update Alert**: Marks row as alerted in Google Sheets                                         |
| Alert User               | Pushover               | Sends push notifications for disconnections    | Check Device and Notify | —                         | **Alert User**: Sends push notification via Pushover. You can change this to any notifying app   |
| Clear Rows Every 2 days  | Schedule Trigger       | Triggers clearing old rows every 2 days         | —                     | Clear sheet                | **Clear Rows Every 2 days**: Cleans up old entries to keep data fresh                           |
| Clear sheet              | Google Sheets          | Clears 500 old rows from the Google Sheet       | Clear Rows Every 2 days | —                         |                                                                                                   |
| Sticky Note              | Sticky Note            | Workflow overview notes                         | —                     | —                         | ## This workflow monitors device connection status from Omada Controller alerts. How it works: Gmail Trigger receives Omada alert emails; Code node parses the alert into structured fields; Data is logged into Google Sheets; Every 5 minutes, workflow checks if any device has been disconnected for 30+ minutes; Sends a Pushover notification for overdue disconnections; Clears old rows from the sheet every 2 days |
| Sticky Note1             | Sticky Note            | Note on Gmail trigger                           | —                     | —                         | **Receives Alert**: Gmail trigger for Omada Controller emails                                   |
| Sticky Note2             | Sticky Note            | Note on processing node                         | —                     | —                         | **Process Email and Extract**: Extracts timestamp, device name, MAC, severity, status           |
| Sticky Note3             | Sticky Note            | Note on appending to sheet                      | —                     | —                         | **Append Row in Sheet**: Logs data to Google Sheets                                             |
| Sticky Note4             | Sticky Note            | Note on schedule trigger                        | —                     | —                         | **Check Every 5 minutes**: Scheduled polling to detect overdue disconnections                    |
| Sticky Note5             | Sticky Note            | Note on device check and notification code     | —                     | —                         | **Check Device and Notify**: Filters devices disconnected >30 minutes                           |
| Sticky Note6             | Sticky Note            | Note on alerting user                           | —                     | —                         | **Alert User**: Sends push notification via Pushover. You can change this to any notifying app  |
| Sticky Note7             | Sticky Note            | Note on sheet update                            | —                     | —                         | **Update Alert**: Marks row as alerted in Google Sheets                                        |
| Sticky Note8             | Sticky Note            | Note on clearing old rows                       | —                     | —                         | **Clear Rows Every 2 days**: Cleans up old entries to keep data fresh                          |

---

### 4. Reproducing the Workflow from Scratch

1. **Create Gmail Trigger node**  
   - Name: "Receives Alert"  
   - Type: Gmail Trigger  
   - Poll interval: Every minute  
   - Credentials: Configure Gmail OAuth2 credentials with appropriate access rights to read emails.  
   - Filters: Leave empty or set specific filters if needed for Omada alerts.

2. **Create Code node**  
   - Name: "Process Email and Extract"  
   - Type: Code (JavaScript)  
   - Purpose: Parse incoming emails or rows and extract fields like timestamp, device name, MAC, severity, status.  
   - Implementation: Use JavaScript to group items by MAC, find the latest record per device, filter for disconnected/isolated statuses, and check if alertSent is not true.  
   - Input: Output from Gmail Trigger node.  
   - Output: Structured JSON records for appending to Google Sheets.

3. **Create Google Sheets Append Row node**  
   - Name: "Append Row in Sheet"  
   - Type: Google Sheets  
   - Operation: Append  
   - Document ID: Set your Google Sheet document ID  
   - Sheet Name / GID: Set your target sheet  
   - Columns: Map fields (mac, name, type, status, category, severity, alertSent, timestamp, checkAfter, timestampISO, timeStampFormated, rowId) from code node output.  
   - Credentials: Google Sheets OAuth2.

4. **Connect nodes:**  
   - "Receives Alert" → "Process Email and Extract" → "Append Row in Sheet"

5. **Create Schedule Trigger node**  
   - Name: "Check Every 5 minutes"  
   - Type: Schedule Trigger  
   - Interval: Every 5 minutes.

6. **Create Google Sheets Get Rows node**  
   - Name: "Get Row(s) in Sheet"  
   - Type: Google Sheets  
   - Operation: Get all rows  
   - Document ID and Sheet Name: Same as Append node  
   - Credentials: Google Sheets OAuth2.

7. **Create Code node**  
   - Name: "Check Device and Notify"  
   - Type: Code (JavaScript)  
   - Purpose: Filter devices disconnected or isolated for more than 30 minutes, adjusting for Philippine time (UTC+8), and check alertSent flag.  
   - Logic: Group by MAC, compare timestamps, filter status, check alertSent.  
   - Input: Rows from "Get Row(s) in Sheet" node.  
   - Output: Array of overdue devices or debug message.

8. **Create Google Sheets Update Row node**  
   - Name: "Update Alert"  
   - Type: Google Sheets  
   - Operation: Update  
   - Document ID and Sheet Name: Same as above  
   - Matching column: rowId  
   - Update column: alertSent = true  
   - Credentials: Google Sheets OAuth2.

9. **Create Pushover node**  
   - Name: "Alert User"  
   - Type: Pushover  
   - Message: Template with device name, status, and formatted timestamp  
   - User Key: Your Pushover user key  
   - Credentials: Pushover API credentials.

10. **Connect nodes:**  
    - "Check Every 5 minutes" → "Get Row(s) in Sheet" → "Check Device and Notify" →  
      - Branch 1: "Update Alert"  
      - Branch 2: "Alert User"

11. **Create Schedule Trigger node**  
    - Name: "Clear Rows Every 2 days"  
    - Type: Schedule Trigger  
    - Interval: Every 2 days  
    - Trigger time: 2:00 AM

12. **Create Google Sheets Clear Rows node**  
    - Name: "Clear sheet"  
    - Type: Google Sheets  
    - Operation: Clear specific rows  
    - Document ID and Sheet Name: Same as above  
    - Start index: 2 (to keep headers)  
    - Rows to clear: 500  
    - Credentials: Google Sheets OAuth2.

13. **Connect nodes:**  
    - "Clear Rows Every 2 days" → "Clear sheet"

---

### 5. General Notes & Resources

| Note Content                                                                                                                     | Context or Link                                                                                       |
|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| This workflow monitors device connection status from TP-Link Omada Controller alerts by integrating Gmail, Google Sheets, and Pushover. | Workflow overview sticky note in the workflow.                                                     |
| You can customize the Pushover node to use other notification services by replacing the node and adjusting credentials accordingly. | Sticky Note6 content on alerting user node.                                                       |
| Ensure your Google Sheets has a proper schema with columns matching the mapped fields to avoid data inconsistency.               | Google Sheets node configuration notes.                                                           |
| Timezone adjustment is set to Philippine Time (UTC+8) in the code node "Check Device and Notify". Adjust if your locale differs. | Code node comments in "Check Device and Notify".                                                  |
| For Gmail trigger, ensure that OAuth2 credentials have the necessary scopes to read emails and that Gmail API quotas are not exceeded. | Gmail Trigger node considerations.                                                                |
| For detailed Pushover setup and user key management, visit https://pushover.net/                                                  | Pushover node official documentation.                                                             |

---

**Disclaimer:** The text provided is derived exclusively from an automated workflow created with n8n, an integration and automation tool. This processing strictly adheres to current content policies and contains no illegal, offensive, or protected elements. All manipulated data is legal and public.