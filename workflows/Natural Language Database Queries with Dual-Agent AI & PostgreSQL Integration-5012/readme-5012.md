Natural Language Database Queries with Dual-Agent AI & PostgreSQL Integration

https://n8nworkflows.xyz/workflows/natural-language-database-queries-with-dual-agent-ai---postgresql-integration-5012


# Natural Language Database Queries with Dual-Agent AI & PostgreSQL Integration

### 1. Workflow Overview

This workflow enables natural language querying of a PostgreSQL database using a dual-agent AI system orchestrated within n8n. It is designed to process user inputs (via Telegram messages, both text and voice), convert natural language requests into SQL SELECT queries, execute those queries on a PostgreSQL database, and then return formatted results back to the user through Telegram.

The workflow is logically divided into these main blocks:

- **1.1 Input Reception & Processing:** Captures user input from Telegram (text or voice), transcribes voice messages to text, and prepares the input for AI processing.

- **1.2 Dual-Agent AI Query Generation & Validation:** Uses two AI agents: a main agent to interpret user intent and compose refined queries, and a sub-agent specialized in generating strictly formatted SQL SELECT queries. Both agents incorporate validation ("Think" nodes) to ensure query accuracy and compliance.

- **1.3 Database Query Execution:** Executes the SQL query generated by the sub-agent against the PostgreSQL database.

- **1.4 Response Delivery:** Sends the query result or response back to the user via Telegram.

- **1.5 Auxiliary & Configuration:** Includes session memory management for chat context persistence and configuration notes.

---

### 2. Block-by-Block Analysis

---

#### 2.1 Input Reception & Processing

**Overview:**  
This block captures incoming Telegram messages, distinguishes between voice and text inputs, transcribes voice messages to text, and merges all inputs into a unified format for AI processing.

**Nodes Involved:**  
- Telegram Trigger1  
- Voice or Text (Switch)  
- Download File1 (Telegram node)  
- Transcribe1 (OpenAI Audio Transcription)  
- Text (Set)  
- Merge

**Node Details:**

- **Telegram Trigger1**  
  - *Type:* Telegram Trigger (Webhook)  
  - *Role:* Listens for new Telegram messages (any message type).  
  - *Config:* Subscribed to 'message' updates; credentials linked to Telegram account.  
  - *IO:* Output to 'Voice or Text'.  
  - *Failure Modes:* Telegram API downtime, webhook misconfiguration.  
  - *Version:* 1.1

- **Voice or Text (Switch)**  
  - *Type:* Switch node  
  - *Role:* Routes messages based on whether they contain voice or text content.  
  - *Config:* Checks if `message.voice.file_id` exists → Voice output; else if `message.text` exists → Text output.  
  - *IO:* Voice → Download File1; Text → Text node.  
  - *Edge Cases:* Messages without voice or text; unsupported media types.  
  - *Version:* 3.2

- **Download File1**  
  - *Type:* Telegram node (file download)  
  - *Role:* Downloads the voice message file from Telegram servers.  
  - *Config:* Uses voice file id from message to download audio.  
  - *Credentials:* Telegram API credentials.  
  - *IO:* Output audio file to Transcribe1.  
  - *Failures:* File not found, network errors.  
  - *Version:* 1.2

- **Transcribe1**  
  - *Type:* OpenAI Audio Transcription node  
  - *Role:* Converts downloaded voice audio to text using OpenAI Whisper API.  
  - *Config:* Default transcription options; OpenAI API credentials required.  
  - *IO:* Output transcription text to Merge node.  
  - *Failures:* API rate limits, audio format errors, transcription inaccuracies.  
  - *Version:* 1.6

- **Text (Set)**  
  - *Type:* Set node  
  - *Role:* Extracts text from Telegram message JSON for downstream processing.  
  - *Config:* Assigns `$json.message.text` to a field named `text`.  
  - *IO:* Output to Merge node.  
  - *Version:* 3.4

- **Merge**  
  - *Type:* Merge node  
  - *Role:* Combines text from transcription or direct text input into a single stream for the main agent.  
  - *Config:* Defaults (no special merge mode specified).  
  - *IO:* Output to Main agent.  
  - *Failures:* Data format mismatches, empty inputs.  
  - *Version:* 3.1

---

#### 2.2 Dual-Agent AI Query Generation & Validation

**Overview:**  
This block uses a two-agent AI architecture: the Main agent interprets user queries and generates refined natural language requests, while the Query agent (sub-agent) transforms these requests into strict SQL SELECT queries. Both agents include "Think" nodes to validate intermediate outputs.

**Nodes Involved:**  
- Main agent (LangChain Agent)  
- Query agent (LangChain Agent)  
- Think1 (Tool Think node)  
- Think (Tool Think node)  
- OpenRouter Chat Model1 (LM for Main agent)  
- OpenRouter Chat Model (LM for Query agent)  
- CALL QUERY AGENT (Tool Workflow calling Query agent sub-workflow)  
- Postgres Chat Memory

**Node Details:**

- **Main agent**  
  - *Type:* LangChain Agent  
  - *Role:* Acts as the primary natural language interpreter and database assistant. It receives unified text input, applies system messages defining database schema and rules, and formulates requests to the sub-agent.  
  - *Config:* Custom system prompt detailing database schema placeholders, operational rules (limits on queries), and response formatting guidelines.  
  - *IO:* Input from Merge; output to SEND MESSAGE. Also linked to CALL QUERY AGENT as an AI tool.  
  - *Failures:* Prompt misconfiguration, model API errors, invalid input formats.  
  - *Version:* 2

- **Query agent**  
  - *Type:* LangChain Agent  
  - *Role:* Specialized sub-agent generating strict SQL SELECT queries from natural language queries.  
  - *Config:* System prompt enforces output-only raw SQL queries with strict formatting rules and database schema placeholders.  
  - *IO:* Input from CALL QUERY AGENT or When Executed by Another Workflow; output to Postgres node.  
  - *Failures:* SQL syntax generation errors, prompt misconfiguration.  
  - *Version:* 2

- **Think1 & Think**  
  - *Type:* LangChain Tool Think nodes  
  - *Role:* Validate if the AI-generated content (queries or interpretation) matches the user input logically and syntactically.  
  - *Config:* Descriptions prompt the AI to think critically about output correctness.  
  - *IO:* Think1 validates Main agent output; Think validates Query agent output.  
  - *Failures:* AI misinterpretation, timeouts.  
  - *Version:* 1

- **OpenRouter Chat Model1 & OpenRouter Chat Model**  
  - *Type:* LangChain Language Model nodes using OpenRouter API  
  - *Role:* Provide the underlying AI model (Anthropic Claude 3.5 Sonnet) for both agents.  
  - *Config:* No special options; linked to OpenRouter API credentials.  
  - *IO:* Provide language model responses for agents.  
  - *Failures:* API errors, credential issues.  
  - *Version:* 1

- **CALL QUERY AGENT**  
  - *Type:* LangChain Tool Workflow  
  - *Role:* Calls the Query agent sub-workflow to generate SQL queries from natural language.  
  - *Config:* References an external workflow by ID; inputs/outputs managed internally.  
  - *IO:* Called from Main agent as AI tool; output linked back to Main agent.  
  - *Failures:* Workflow unavailability, parameter mismatches.  
  - *Version:* 2.2

- **Postgres Chat Memory**  
  - *Type:* LangChain Postgres Chat Memory  
  - *Role:* Maintains chat session context and memory to enable coherent multi-turn conversations.  
  - *Config:* Uses a custom session key; PostgreSQL credentials configured.  
  - *IO:* Connected to Main agent's AI memory input.  
  - *Failures:* Database connection errors, session key collisions.  
  - *Version:* 1.3

---

#### 2.3 Database Query Execution

**Overview:**  
This block executes the SQL query generated by the Query agent against the configured PostgreSQL database and returns the results.

**Nodes Involved:**  
- ACCES DATABASE WITH DYNAMIC QUERYS (PostgreSQL node)

**Node Details:**

- **ACCES DATABASE WITH DYNAMIC QUERYS**  
  - *Type:* PostgreSQL node  
  - *Role:* Executes dynamic SQL queries received as input from Query agent output.  
  - *Config:* Query parameter set to `{{ $json.output }}` (output from Query agent). Uses options to handle large numbers and replace empty strings.  
  - *Credentials:* PostgreSQL account credentials required.  
  - *IO:* Input from Query agent output; output likely used by Main agent for response formatting (though direct connection not shown in JSON snippet).  
  - *Failures:* SQL syntax errors, database connectivity issues, query timeouts, injection risks if input unvalidated.  
  - *Version:* 2.6

---

#### 2.4 Response Delivery

**Overview:**  
Sends the final formatted response from the Main agent back to the user on Telegram.

**Nodes Involved:**  
- SEND MESSAGE

**Node Details:**

- **SEND MESSAGE**  
  - *Type:* Telegram node (send message)  
  - *Role:* Sends text message responses back to the Telegram chat identified by a fixed chat ID.  
  - *Config:* Text content is dynamically set as `{{ $json.output }}` from Main agent output. Chat ID is statically configured (placeholder `(YOUR CHAT ID)`).  
  - *Credentials:* Telegram API credentials.  
  - *Failures:* Incorrect chat ID, Telegram API errors, message length limits.  
  - *Version:* 1.2

---

#### 2.5 Auxiliary & Configuration

**Overview:**  
Contains notes and setup guides for operators and developers.

**Nodes Involved:**  
- When Executed by Another Workflow  
- Sticky Note(s)

**Node Details:**

- **When Executed by Another Workflow**  
  - *Type:* Execute Workflow Trigger  
  - *Role:* Allows this workflow to be triggered programmatically by another workflow, passing data through.  
  - *Config:* Input source set to passthrough.  
  - *IO:* Output connected to Query agent.  
  - *Failures:* Trigger misconfigurations, missing input data.  
  - *Version:* 1.1

- **Sticky Notes (3 total)**  
  - *Type:* Sticky Note nodes  
  - *Role:* Provide in-editor documentation and architecture diagrams, setup checklists, critical operational rules, and workflow architecture visuals.  
  - *Content Highlights:* Instructions on replacing placeholders with actual table and field names; critical system limits (e.g. query limits); architecture diagrams showing flow from user to database and back.  
  - *Failures:* None (documentation only).  
  - *Version:* 1

---

### 3. Summary Table

| Node Name                     | Node Type                           | Functional Role                           | Input Node(s)                 | Output Node(s)                  | Sticky Note                                                                                                            |
|-------------------------------|-----------------------------------|-----------------------------------------|------------------------------|-------------------------------|------------------------------------------------------------------------------------------------------------------------|
| Telegram Trigger1              | Telegram Trigger                  | Captures incoming Telegram messages     | -                            | Voice or Text                 |                                                                                                                        |
| Voice or Text                 | Switch                           | Routes input by message type (voice/text) | Telegram Trigger1            | Download File1, Text           |                                                                                                                        |
| Download File1                | Telegram node (file download)    | Downloads voice message audio            | Voice or Text (Voice path)    | Transcribe1                   |                                                                                                                        |
| Transcribe1                  | OpenAI Audio Transcription       | Transcribes voice audio to text          | Download File1                | Merge                        |                                                                                                                        |
| Text                         | Set                             | Extracts text from Telegram message      | Voice or Text (Text path)     | Merge                        |                                                                                                                        |
| Merge                        | Merge                           | Consolidates text input for AI processing | Transcribe1, Text             | Main agent                   |                                                                                                                        |
| Main agent                   | LangChain Agent                 | Interprets user input, generates refined queries | Merge, Postgres Chat Memory, CALL QUERY AGENT | SEND MESSAGE                | # MAIN AGENT (Sticky Note)                                                                                              |
| Query agent                 | LangChain Agent                 | Converts natural language to SQL SELECT queries | When Executed by Another Workflow, CALL QUERY AGENT, Think   | ACCES DATABASE WITH DYNAMIC QUERYS | # SUB AGENT (Sticky Note)                                                                                               |
| Think                       | LangChain Tool Think            | Validates Query agent output             | Query agent                  | Query agent                  |                                                                                                                        |
| Think1                      | LangChain Tool Think            | Validates Main agent output               | Main agent                   | Main agent                   |                                                                                                                        |
| OpenRouter Chat Model        | LangChain LM (OpenRouter)       | Provides AI language model for Query agent | Query agent                  | Query agent                  |                                                                                                                        |
| OpenRouter Chat Model1       | LangChain LM (OpenRouter)       | Provides AI language model for Main agent  | Main agent                   | Main agent                   |                                                                                                                        |
| CALL QUERY AGENT             | LangChain Tool Workflow         | Calls sub-agent workflow for SQL query generation | Main agent                   | Main agent                   |                                                                                                                        |
| Postgres Chat Memory         | LangChain Postgres Memory       | Maintains session context for chat       | Main agent                   | Main agent                   |                                                                                                                        |
| ACCES DATABASE WITH DYNAMIC QUERYS | PostgreSQL node                | Executes generated SQL queries            | Query agent                  | (Implicit to Main agent)      |                                                                                                                        |
| SEND MESSAGE                | Telegram node (send message)    | Sends response back to Telegram user     | Main agent                   | -                            |                                                                                                                        |
| When Executed by Another Workflow | Execute Workflow Trigger        | Allows external triggering of Query agent  | -                            | Query agent                  |                                                                                                                        |
| Sticky Note                 | Sticky Note                    | Documentation & architecture visualization | -                            | -                            | # MAIN AGENT, # SUB AGENT, Setup & Configuration Guide including system limits and architecture diagrams               |

---

### 4. Reproducing the Workflow from Scratch

1. **Create Telegram Trigger:**  
   - Node type: Telegram Trigger  
   - Configure to listen for 'message' updates.  
   - Set Telegram API credentials.

2. **Add Switch Node "Voice or Text":**  
   - Node type: Switch  
   - Add two outputs:  
     - "Voice": condition checks if `message.voice.file_id` exists.  
     - "Text": condition checks if `message.text` exists.

3. **Setup "Download File1" Node:**  
   - Node type: Telegram  
   - Operation: Download file using `message.voice.file_id`.  
   - Credentials: Telegram API.

4. **Setup "Transcribe1" Node:**  
   - Node type: OpenAI Audio Transcription  
   - Operation: Transcribe audio input.  
   - Credentials: OpenAI API.

5. **Setup "Text" Node:**  
   - Node type: Set  
   - Assign `text` field with value from `message.text`.

6. **Add "Merge" Node:**  
   - Node type: Merge  
   - Merge outputs from Transcribe1 and Text nodes.

7. **Setup Postgres Chat Memory:**  
   - Node type: LangChain Postgres Chat Memory  
   - Configure with PostgreSQL credentials.  
   - Set session key (e.g., "C08SU8T0FJ8").

8. **Setup OpenRouter Chat Model Nodes:**  
   - Two nodes: one for Main agent, one for Query agent.  
   - Use OpenRouter API credentials.  
   - Model: "anthropic/claude-3.5-sonnet".

9. **Create Query agent LangChain Agent:**  
   - Input: natural language query.  
   - System message: SQL query generator prompt with strict rules and placeholders for your database schema and table name.  
   - Connect OpenRouter Chat Model as languageModel.  
   - Connect Think node for validation.

10. **Create Main agent LangChain Agent:**  
    - Input: unified text from Merge node.  
    - System message: database assistant prompt with operational rules and placeholders for schema and fields.  
    - Connect OpenRouter Chat Model1 as languageModel.  
    - Connect Postgres Chat Memory as ai_memory.  
    - Connect CALL QUERY AGENT node as AI tool for sub-agent integration.  
    - Connect Think1 node for validation.

11. **Setup CALL QUERY AGENT Node:**  
    - Node type: LangChain Tool Workflow  
    - Reference the Query agent workflow by workflow ID or recreate it inline.  
    - Map inputs and outputs accordingly.

12. **Setup PostgreSQL Node "ACCES DATABASE WITH DYNAMIC QUERYS":**  
    - Operation: executeQuery  
    - Query: `{{ $json.output }}` (from Query agent output)  
    - Configure PostgreSQL credentials.

13. **Connect Query agent output to PostgreSQL node input.**

14. **Connect PostgreSQL node output to Main agent (for further processing if needed).**

15. **Setup Telegram "SEND MESSAGE" Node:**  
    - Node type: Telegram  
    - Configure text to send `{{ $json.output }}` from Main agent.  
    - Specify the chatId (replace `(YOUR CHAT ID)` with actual Telegram chat ID).  
    - Use Telegram API credentials.

16. **Connect Main agent output to SEND MESSAGE node input.**

17. **Optional: Add "When Executed by Another Workflow" node:**  
    - Allows triggering Query agent externally.  
    - Input passthrough to Query agent.

18. **Add Sticky Notes within n8n editor:**  
    - Document main agent, sub-agent, system limits, and architecture as per your project needs.

---

### 5. General Notes & Resources

| Note Content                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Context or Link                                                           |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| Setup & Configuration Guide with checklist, database configuration instructions, agent template replacements, critical system limits, and a workflow architecture diagram illustrating the flow from user input to response delivery.                                                                                                                                                                                                                                                                                                                                                                                     | Provided in Sticky Note2 within workflow                                 |
| Critical system limits emphasize always using LIMIT clauses (default 10, max 50), disallowing unlimited or unsafe queries, and enforcing ORDER BY with LIMIT to ensure database stability.                                                                                                                                                                                                                                                                                                                                                                                                                                   | Sticky Note2                                                             |
| Dual-agent AI architecture improves SQL query safety by isolating query generation in a dedicated sub-agent with strict output formatting to prevent injection or non-SELECT queries.                                                                                                                                                                                                                                                                                                                                                                                                                                       | Workflow description and Split Agent design                             |
| Telegram chat ID must be replaced with actual chat ID to ensure responses reach correct user or group.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | SEND MESSAGE node parameter (chatId)                                   |
| Database schema placeholders (`[YOUR_TABLE_NAME]`, `[field_name]`, etc.) must be replaced with real table and column names for accurate SQL query generation.                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Main agent and Query agent system messages                              |
| OpenRouter API credentials and OpenAI API credentials (for transcription) must be configured properly with access permissions and rate limits respected.                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Nodes OpenRouter Chat Model, Transcribe1 node                           |
| For multi-turn conversations, Postgres Chat Memory maintains context, requiring a running PostgreSQL instance accessible with provided credentials.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Postgres Chat Memory node                                               |

---

**Disclaimer:**  
The provided text is exclusively derived from an automated workflow created with n8n, an integration and automation tool. This processing strictly complies with applicable content policies and contains no illegal, offensive, or protected elements. All data handled are legal and publicly available.