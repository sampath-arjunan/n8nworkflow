Automate Wazuh Alert Triage and Reporting with GPT-4o-mini and Telegram

https://n8nworkflows.xyz/workflows/automate-wazuh-alert-triage-and-reporting-with-gpt-4o-mini-and-telegram-6978


# Automate Wazuh Alert Triage and Reporting with GPT-4o-mini and Telegram

### 1. Workflow Overview

This workflow automates the triage and reporting of security alerts generated by Wazuh, a security monitoring tool. It receives alerts via webhook, filters for low-severity alerts, summarizes the alert data using an AI language model (GPT-4o-mini), and then sends a formatted investigation report to a SOC (Security Operations Center) team via Telegram.

Logical blocks:

- **1.1 Input Reception:** Receive Wazuh alerts through a webhook.
- **1.2 Severity Filtering:** Filter alerts based on severity level ("1 low").
- **1.3 AI-Powered Investigation Summarization:** Use a custom GPT-4o-mini model to generate a detailed, structured investigation report from alert data.
- **1.4 SOC Notification:** Send the summarized investigation report to SOC team members on Telegram.
- **1.5 No-Operation Handling:** Gracefully handle non-low severity alerts by doing nothing.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception

- **Overview:** This block captures incoming security alerts from Wazuh via an HTTP POST webhook.
- **Nodes Involved:** 
  - Wazuh Alert

- **Node Details:**

  - **Wazuh Alert**
    - Type: Webhook (HTTP POST endpoint)
    - Role: Entry point for receiving alert payloads from Wazuh.
    - Configuration:
      - HTTP Method: POST
      - Raw Body: Enabled (captures the entire raw request body)
      - Path: Not explicitly set (default or root)
    - Input: External HTTP POST request from Wazuh
    - Output: Alert JSON data passed downstream
    - Edge Cases:
      - Invalid or malformed JSON payloads could cause failures downstream.
      - Missing severity field or unexpected formats.
      - Webhook path conflicts if multiple workflows use the same path.
    - Version: n8n node type version 2

#### 2.2 Severity Filtering

- **Overview:** Filters incoming alerts to process only those with severity level exactly "1 low". Alerts that do not meet this criteria are sent to a No Operation node to halt further processing.
- **Nodes Involved:** 
  - If
  - No Operations

- **Node Details:**

  - **If**
    - Type: Conditional node
    - Role: Filter alerts by severity field in the JSON body.
    - Configuration:
      - Condition: `$json.body.severity` equals `"1 low"` (case insensitive, strict type validation)
      - Combinator: AND (only one condition here)
    - Input: Alert JSON from Wazuh Alert node
    - Outputs:
      - True branch: Alerts with severity "1 low"
      - False branch: All other alerts
    - Edge Cases:
      - Missing `body.severity` field leads to false branch.
      - Case sensitivity is ignored but the exact string must match.
    - Version: n8n node type version 2.2

  - **No Operations**
    - Type: No Operation (noOp)
    - Role: Gracefully ends processing for alerts that do not require investigation.
    - Configuration: None
    - Input: False branch from If node
    - Output: None
    - Edge Cases: None (safe sink)

#### 2.3 AI-Powered Investigation Summarization

- **Overview:** Utilizes the GPT-4o-mini model to analyze and summarize the Wazuh alert details into a structured investigation report, including attack tactics, impacted scope, external artifact reputation checks, and security recommendations.
- **Nodes Involved:**
  - Investigation Summarization
  - Customized AI Model

- **Node Details:**

  - **Investigation Summarization**
    - Type: LangChain Summarization Chain
    - Role: Orchestrates AI summarization of alert data using templates and prompts.
    - Configuration:
      - Summarization method uses a custom prompt instructing the AI to act as an experienced SOC AI Analyst.
      - Input prompt template includes placeholders for alert details (`{{ $json.body.all_fields.full_log }}`) and requests a specific structured format:
        - Alert Name
        - Alert Description
        - MITRE Tactic & Technique
        - Impacted Scope (source IP, destination IP, host machine)
        - External Artifact Reputation check
        - Analysis
        - Security Recommendations
      - Prompt encourages a concise, line-by-line organized report.
    - Input: True branch of If node (alerts with severity "1 low")
    - Output: Summarized investigation report as `output.text`
    - Connections:
      - Sends prompt to Customized AI Model node for completion.
    - Edge Cases:
      - Missing or incomplete `full_log` or alert data may cause incomplete reports.
      - AI model errors or timeouts.
      - Prompt formatting errors if expressions fail.
    - Version: 2.1

  - **Customized AI Model**
    - Type: LangChain OpenAI Chat Model
    - Role: Executes the GPT-4o-mini AI model call to generate text completions for the investigation summary.
    - Configuration:
      - Model: `gpt-4o-mini`
      - No additional options configured.
    - Credentials: Requires valid OpenAI API credentials.
    - Input: Prompt from Investigation Summarization node.
    - Output: AI-generated text report.
    - Edge Cases:
      - OpenAI API authentication failure.
      - API rate limits or network issues.
      - Model version changes affecting output style.
    - Version: 1.2

#### 2.4 SOC Notification

- **Overview:** Sends the AI-generated investigation report to the SOC team via Telegram, after cleaning Markdown characters and formatting the text for readability.
- **Nodes Involved:**
  - SOC Team

- **Node Details:**

  - **SOC Team**
    - Type: Telegram node
    - Role: Send finalized investigation report message to Telegram chat.
    - Configuration:
      - Text: Cleans AI output by stripping escape slashes, Markdown syntax characters (`*`, `#`, `_`, `[ ]`, `` ` ``), trims extra spaces and newlines, replaces hyphens with em dashes for clarity.
      - Chat ID: Configurable chat/group ID.
      - Additional Field: Append Attribution enabled.
    - Input: Output text from Investigation Summarization node.
    - Credentials: Requires Telegram API credentials (bot token).
    - Edge Cases:
      - Invalid or missing Telegram chat ID.
      - Network issues or Telegram API rate limits.
      - Text length limits for Telegram messages (must be considered if reports are very long).
    - Version: 1.2

---

### 3. Summary Table

| Node Name               | Node Type                          | Functional Role                         | Input Node(s)      | Output Node(s)             | Sticky Note                                           |
|-------------------------|----------------------------------|---------------------------------------|--------------------|----------------------------|-------------------------------------------------------|
| Wazuh Alert             | Webhook                          | Receive Wazuh alerts via HTTP POST    | External HTTP POST  | If                         |                                                       |
| If                      | If                               | Filter alerts by severity = "1 low"   | Wazuh Alert        | Investigation Summarization, No Operations |                                                       |
| No Operations           | No Operation (noOp)              | End processing for non-low severity   | If (false branch)  | None                       |                                                       |
| Investigation Summarization | LangChain Chain Summarization | Generate AI investigation report      | If (true branch)   | SOC Team                   |                                                       |
| Customized AI Model     | LangChain OpenAI Chat Model      | Call GPT-4o-mini for text generation  | Investigation Summarization (AI input) | Investigation Summarization (AI output) | Requires OpenAI API credentials                         |
| SOC Team                | Telegram                         | Send report to SOC team via Telegram  | Investigation Summarization | None                       | Clean text of Markdown and escape chars before sending |

---

### 4. Reproducing the Workflow from Scratch

1. **Create Webhook Node: "Wazuh Alert"**
   - Type: Webhook
   - HTTP Method: POST
   - Path: (choose appropriate unique path or leave blank for root)
   - Enable "Raw Body" to capture entire request content.
   - Purpose: Receive incoming Wazuh alerts.

2. **Add Conditional Node: "If"**
   - Type: If
   - Condition:
     - Left Value: `{{$json.body.severity}}`
     - Operator: Equals
     - Right Value: `1 low`
     - Ignore case: True
     - Type validation: Strict
   - Connect input from "Wazuh Alert" node's main output.

3. **Add No Operation Node: "No Operations"**
   - Type: No Operation (noOp)
   - Connect input from the false output of the "If" node.
   - Purpose: End flow for alerts that are not low severity.

4. **Add LangChain Summarization Node: "Investigation Summarization"**
   - Type: LangChain Chain Summarization
   - Configuration:
     - Use "summarizationMethodAndPrompts" option.
     - Set prompt text to:
       ```
       You are the experienced SOC AI Analyst designed by Mariskarthick M, Analyse the following and provide the detailed investigation with the below mentioned format.

       "#Analyse:
       {{ $json.body.all_fields.full_log }}

       #Format:
       Alert Name: 
       Alert Description: (describe about that alert)
       Mitre Tactic & Technique
       Impacted Scope: Source IP, Destination IP, Host Machine

       External Artifacts Reputation check:

       Analysis:

       Security Recommendations.

       Please make the investigation report in organized way and each fields line by line.
       {{ $json.body }}"
       ```
     - Connect the true output of "If" node to this node.

5. **Add LangChain OpenAI Chat Model Node: "Customized AI Model"**
   - Type: LangChain OpenAI Chat Model
   - Model: Select `gpt-4o-mini`
   - Credentials: Configure with valid OpenAI API credentials.
   - Connect the AI input of "Investigation Summarization" node to this node.
   - Connect AI output of this node back to "Investigation Summarization" for final output.

6. **Add Telegram Node: "SOC Team"**
   - Type: Telegram
   - Text Parameter: Use an expression to clean and format the AI output text:
     ```javascript
     {{$json.output.text
       .replaceAll('\\', '')
       .replaceAll('*', '')
       .replaceAll('#', '')
       .replaceAll('_', '')
       .replaceAll('[', '')
       .replaceAll(']', '')
       .replaceAll('`', '')
       .replaceAll('  ', ' ')
       .replaceAll('\n\n', '\n')
       .replaceAll('\n ', '\n')
       .replaceAll(' - ', ' — ')
       .trim()
     }}
     ```
   - Chat ID: Set your Telegram chat or group ID.
   - Additional Fields: Enable "Append Attribution" to add message footer.
   - Credentials: Configure with Telegram Bot API credentials.
   - Connect input from the main output of "Investigation Summarization".

7. **Connect the nodes following this flow:**
   - Wazuh Alert → If
   - If (true) → Investigation Summarization → Customized AI Model (AI chat) → Investigation Summarization (final output) → SOC Team
   - If (false) → No Operations

8. **Workflow Settings:**
   - Set execution order to default or version 1.
   - Activate workflow.

---

### 5. General Notes & Resources

| Note Content                                                                                                                                | Context or Link                                                                                                  |
|---------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|
| Workflow created to integrate Wazuh alerts with AI-powered investigation summaries, leveraging GPT-4o-mini and Telegram notifications.      | Workflow description and design                                                                                |
| Prompt engineering credits to Mariskarthick M for SOC AI Analyst persona and structured reporting format.                                   | Prompt text inside Investigation Summarization node                                                           |
| Telegram message cleaning expression removes markdown and escape characters to ensure clean SOC team communication.                        | See SOC Team node text parameter                                                                               |
| OpenAI API credentials must be configured properly to use GPT-4o-mini language model in n8n LangChain integration.                         | OpenAI official docs: https://platform.openai.com/docs/api-reference                                             |
| Telegram Bot API credentials and chat IDs must be valid and authorized for sending messages to the SOC team.                                | Telegram Bot API docs: https://core.telegram.org/bots/api                                                       |
| Consider handling API rate limits and network failures for OpenAI and Telegram nodes to improve robustness.                                 | Best practices for API error handling                                                                           |

---

**Disclaimer:** The provided text is exclusively derived from an automated workflow created with n8n, an integration and automation tool. This process strictly adheres to current content policies and contains no illegal, offensive, or protected elements. All data handled is legal and public.